THREE.RenderableObject=function(){this.id=0;this.object=null;this.z=0;this.renderOrder=0};THREE.RenderableFace=function(){this.id=0;this.v1=new THREE.RenderableVertex;this.v2=new THREE.RenderableVertex;this.v3=new THREE.RenderableVertex;this.normalModel=new THREE.Vector3;this.vertexNormalsModel=[new THREE.Vector3,new THREE.Vector3,new THREE.Vector3];this.vertexNormalsLength=0;this.color=new THREE.Color;this.material=null;this.uvs=[new THREE.Vector2,new THREE.Vector2,new THREE.Vector2];this.z=0;this.renderOrder=0};THREE.RenderableVertex=function(){this.position=new THREE.Vector3;this.positionWorld=new THREE.Vector3;this.positionScreen=new THREE.Vector4;this.visible=true};THREE.RenderableVertex.prototype.copy=function(e){this.positionWorld.copy(e.positionWorld);this.positionScreen.copy(e.positionScreen)};THREE.RenderableLine=function(){this.id=0;this.v1=new THREE.RenderableVertex;this.v2=new THREE.RenderableVertex;this.vertexColors=[new THREE.Color,new THREE.Color];this.material=null;this.z=0;this.renderOrder=0};THREE.RenderableSprite=function(){this.id=0;this.object=null;this.x=0;this.y=0;this.z=0;this.rotation=0;this.scale=new THREE.Vector2;this.material=null;this.renderOrder=0};THREE.Projector=function(){var Z,$,r=[],t=0,s,_,ee=[],n=0,re,te,i=[],o=0,ne,ie,a=[],l=0,oe,ae,c=[],u=0,se={objects:[],lights:[],elements:[]},le=new THREE.Vector3,ce=new THREE.Vector4,h=new THREE.Box3(new THREE.Vector3(-1,-1,-1),new THREE.Vector3(1,1,1)),m=new THREE.Box3,R=new Array(3),e=new Array(4),ue=new THREE.Matrix4,pe=new THREE.Matrix4,fe,Ee=new THREE.Matrix4,ve=new THREE.Matrix3,de=new THREE.Frustum,he=new THREE.Vector4,me=new THREE.Vector4;this.projectVector=function(e,r){console.warn("THREE.Projector: .projectVector() is now vector.project().");e.project(r)};this.unprojectVector=function(e,r){console.warn("THREE.Projector: .unprojectVector() is now vector.unproject().");e.unproject(r)};this.pickingRay=function(e,r){console.error("THREE.Projector: .pickingRay() is now raycaster.setFromCamera().")};var p=function(){var c=[];var u=[];var p=null;var f=null;var E=new THREE.Matrix3;function e(e){p=e;f=p.material;E.getNormalMatrix(p.matrixWorld);c.length=0;u.length=0}function n(e){var r=e.position;var t=e.positionWorld;var n=e.positionScreen;t.copy(r).applyMatrix4(fe);n.copy(t).applyMatrix4(pe);var i=1/n.w;n.x*=i;n.y*=i;n.z*=i;e.visible=n.x>=-1&&n.x<=1&&n.y>=-1&&n.y<=1&&n.z>=-1&&n.z<=1}function r(e,r,t){s=ye();s.position.set(e,r,t);n(s)}function t(e,r,t){c.push(e,r,t)}function i(e,r){u.push(e,r)}function v(e,r,t){if(e.visible===true||r.visible===true||t.visible===true)return true;R[0]=e.positionScreen;R[1]=r.positionScreen;R[2]=t.positionScreen;return h.intersectsBox(m.setFromPoints(R))}function d(e,r,t){return(t.positionScreen.x-e.positionScreen.x)*(r.positionScreen.y-e.positionScreen.y)-(t.positionScreen.y-e.positionScreen.y)*(r.positionScreen.x-e.positionScreen.x)<0}function o(e,r){var t=ee[e];var n=ee[r];ne=He();ne.id=p.id;ne.v1.copy(t);ne.v2.copy(n);ne.z=(t.positionScreen.z+n.positionScreen.z)/2;ne.renderOrder=p.renderOrder;ne.material=p.material;se.elements.push(ne)}function a(e,r,t){var n=ee[e];var i=ee[r];var o=ee[t];if(v(n,i,o)===false)return;if(f.side===THREE.DoubleSide||d(n,i,o)===true){re=Te();re.id=p.id;re.v1.copy(n);re.v2.copy(i);re.v3.copy(o);re.z=(n.positionScreen.z+i.positionScreen.z+o.positionScreen.z)/3;re.renderOrder=p.renderOrder;re.normalModel.fromArray(c,e*3);re.normalModel.applyMatrix3(E).normalize();for(var a=0;a<3;a++){var s=re.vertexNormalsModel[a];s.fromArray(c,arguments[a]*3);s.applyMatrix3(E).normalize();var l=re.uvs[a];l.fromArray(u,arguments[a]*2)}re.vertexNormalsLength=3;re.material=p.material;se.elements.push(re)}}return{setObject:e,projectVertex:n,checkTriangleVisibility:v,checkBackfaceCulling:d,pushVertex:r,pushNormal:t,pushUv:i,pushLine:o,pushTriangle:a}};var Re=new p;this.projectScene=function(e,r,t,n){te=0;ie=0;ae=0;se.elements.length=0;if(e.autoUpdate===true)e.updateMatrixWorld();if(r.parent===null)r.updateMatrixWorld();ue.copy(r.matrixWorldInverse.getInverse(r.matrixWorld));pe.multiplyMatrices(r.projectionMatrix,ue);de.setFromMatrix(pe);$=0;se.objects.length=0;se.lights.length=0;function i(e){Z=xe();Z.id=e.id;Z.object=e;le.setFromMatrixPosition(e.matrixWorld);le.applyMatrix4(pe);Z.z=le.z;Z.renderOrder=e.renderOrder;se.objects.push(Z)}e.traverseVisible(function(e){if(e instanceof THREE.Light){se.lights.push(e)}else if(e instanceof THREE.Mesh||e instanceof THREE.Line){if(e.material.visible===false)return;if(e.frustumCulled===true&&de.intersectsObject(e)===false)return;i(e)}else if(e instanceof THREE.Sprite){if(e.material.visible===false)return;if(e.frustumCulled===true&&de.intersectsSprite(e)===false)return;i(e)}});if(t===true){se.objects.sort(ge)}for(var o=0,a=se.objects.length;o<a;o++){var s=se.objects[o].object;var l=s.geometry;Re.setObject(s);fe=s.matrixWorld;_=0;if(s instanceof THREE.Mesh){if(l instanceof THREE.BufferGeometry){var c=l.attributes;var u=l.groups;if(c.position===undefined)continue;var p=c.position.array;for(var f=0,E=p.length;f<E;f+=3){Re.pushVertex(p[f],p[f+1],p[f+2])}if(c.normal!==undefined){var v=c.normal.array;for(var f=0,E=v.length;f<E;f+=3){Re.pushNormal(v[f],v[f+1],v[f+2])}}if(c.uv!==undefined){var d=c.uv.array;for(var f=0,E=d.length;f<E;f+=2){Re.pushUv(d[f],d[f+1])}}if(l.index!==null){var h=l.index.array;if(u.length>0){for(var m=0;m<u.length;m++){var R=u[m];for(var f=R.start,E=R.start+R.count;f<E;f+=3){Re.pushTriangle(h[f],h[f+1],h[f+2])}}}else{for(var f=0,E=h.length;f<E;f+=3){Re.pushTriangle(h[f],h[f+1],h[f+2])}}}else{for(var f=0,E=p.length/3;f<E;f+=3){Re.pushTriangle(f,f+1,f+2)}}}else if(l instanceof THREE.Geometry){var x=l.vertices;var y=l.faces;var T=l.faceVertexUvs[0];ve.getNormalMatrix(fe);var H=s.material;var w=H instanceof THREE.MultiMaterial;var g=w===true?s.material:null;for(var b=0,M=x.length;b<M;b++){var S=x[b];le.copy(S);if(H.morphTargets===true){var z=l.morphTargets;var V=s.morphTargetInfluences;for(var j=0,O=z.length;j<O;j++){var C=V[j];if(C===0)continue;var L=z[j];var k=L.vertices[b];le.x+=(k.x-S.x)*C;le.y+=(k.y-S.y)*C;le.z+=(k.z-S.z)*C}}Re.pushVertex(le.x,le.y,le.z)}for(var N=0,W=y.length;N<W;N++){var B=y[N];H=w===true?g.materials[B.materialIndex]:s.material;if(H===undefined)continue;var F=H.side;var P=ee[B.a];var A=ee[B.b];var D=ee[B.c];if(Re.checkTriangleVisibility(P,A,D)===false)continue;var G=Re.checkBackfaceCulling(P,A,D);if(F!==THREE.DoubleSide){if(F===THREE.FrontSide&&G===false)continue;if(F===THREE.BackSide&&G===true)continue}re=Te();re.id=s.id;re.v1.copy(P);re.v2.copy(A);re.v3.copy(D);re.normalModel.copy(B.normal);if(G===false&&(F===THREE.BackSide||F===THREE.DoubleSide)){re.normalModel.negate()}re.normalModel.applyMatrix3(ve).normalize();var I=B.vertexNormals;for(var U=0,q=Math.min(I.length,3);U<q;U++){var J=re.vertexNormalsModel[U];J.copy(I[U]);if(G===false&&(F===THREE.BackSide||F===THREE.DoubleSide)){J.negate()}J.applyMatrix3(ve).normalize()}re.vertexNormalsLength=I.length;var K=T[N];if(K!==undefined){for(var Q=0;Q<3;Q++){re.uvs[Q].copy(K[Q])}}re.color=B.color;re.material=H;re.z=(P.positionScreen.z+A.positionScreen.z+D.positionScreen.z)/3;re.renderOrder=s.renderOrder;se.elements.push(re)}}}else if(s instanceof THREE.Line){if(l instanceof THREE.BufferGeometry){var c=l.attributes;if(c.position!==undefined){var p=c.position.array;for(var f=0,E=p.length;f<E;f+=3){Re.pushVertex(p[f],p[f+1],p[f+2])}if(l.index!==null){var h=l.index.array;for(var f=0,E=h.length;f<E;f+=2){Re.pushLine(h[f],h[f+1])}}else{var X=s instanceof THREE.LineSegments?2:1;for(var f=0,E=p.length/3-1;f<E;f+=X){Re.pushLine(f,f+1)}}}}else if(l instanceof THREE.Geometry){Ee.multiplyMatrices(pe,fe);var x=s.geometry.vertices;if(x.length===0)continue;P=ye();P.positionScreen.copy(x[0]).applyMatrix4(Ee);var X=s instanceof THREE.LineSegments?2:1;for(var b=1,M=x.length;b<M;b++){P=ye();P.positionScreen.copy(x[b]).applyMatrix4(Ee);if((b+1)%X>0)continue;A=ee[_-2];he.copy(P.positionScreen);me.copy(A.positionScreen);if(be(he,me)===true){he.multiplyScalar(1/he.w);me.multiplyScalar(1/me.w);ne=He();ne.id=s.id;ne.v1.positionScreen.copy(he);ne.v2.positionScreen.copy(me);ne.z=Math.max(he.z,me.z);ne.renderOrder=s.renderOrder;ne.material=s.material;if(s.material.vertexColors===THREE.VertexColors){ne.vertexColors[0].copy(s.geometry.colors[b]);ne.vertexColors[1].copy(s.geometry.colors[b-1])}se.elements.push(ne)}}}}else if(s instanceof THREE.Sprite){ce.set(fe.elements[12],fe.elements[13],fe.elements[14],1);ce.applyMatrix4(pe);var Y=1/ce.w;ce.z*=Y;if(ce.z>=-1&&ce.z<=1){oe=we();oe.id=s.id;oe.x=ce.x*Y;oe.y=ce.y*Y;oe.z=ce.z;oe.renderOrder=s.renderOrder;oe.object=s;oe.rotation=s.rotation;oe.scale.x=s.scale.x*Math.abs(oe.x-(ce.x+r.projectionMatrix.elements[0])/(ce.w+r.projectionMatrix.elements[12]));oe.scale.y=s.scale.y*Math.abs(oe.y-(ce.y+r.projectionMatrix.elements[5])/(ce.w+r.projectionMatrix.elements[13]));oe.material=s.material;se.elements.push(oe)}}}if(n===true){se.elements.sort(ge)}return se};function xe(){if($===t){var e=new THREE.RenderableObject;r.push(e);t++;$++;return e}return r[$++]}function ye(){if(_===n){var e=new THREE.RenderableVertex;ee.push(e);n++;_++;return e}return ee[_++]}function Te(){if(te===o){var e=new THREE.RenderableFace;i.push(e);o++;te++;return e}return i[te++]}function He(){if(ie===l){var e=new THREE.RenderableLine;a.push(e);l++;ie++;return e}return a[ie++]}function we(){if(ae===u){var e=new THREE.RenderableSprite;c.push(e);u++;ae++;return e}return c[ae++]}function ge(e,r){if(e.renderOrder!==r.renderOrder){return e.renderOrder-r.renderOrder}else if(e.z!==r.z){return r.z-e.z}else if(e.id!==r.id){return e.id-r.id}else{return 0}}function be(e,r){var t=0,n=1,i=e.z+e.w,o=r.z+r.w,a=-e.z+e.w,s=-r.z+r.w;if(i>=0&&o>=0&&a>=0&&s>=0){return true}else if(i<0&&o<0||a<0&&s<0){return false}else{if(i<0){t=Math.max(t,i/(i-o))}else if(o<0){n=Math.min(n,i/(i-o))}if(a<0){t=Math.max(t,a/(a-s))}else if(s<0){n=Math.min(n,a/(a-s))}if(n<t){return false}else{e.lerp(r,t);r.lerp(e,1-n);return true}}}};