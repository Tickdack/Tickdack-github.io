THREE.SpriteCanvasMaterial=function(e){THREE.Material.call(this);this.type="SpriteCanvasMaterial";this.color=new THREE.Color(16777215);this.program=function(e,i){};this.setValues(e)};THREE.SpriteCanvasMaterial.prototype=Object.create(THREE.Material.prototype);THREE.SpriteCanvasMaterial.prototype.constructor=THREE.SpriteCanvasMaterial;THREE.SpriteCanvasMaterial.prototype.clone=function(){var e=new THREE.SpriteCanvasMaterial;e.copy(this);e.color.copy(this.color);e.program=this.program;return e};THREE.CanvasRenderer=function(e){console.log("THREE.CanvasRenderer",THREE.REVISION);e=e||{};var c=this,s,l,f,p=new THREE.Projector,n=e.canvas!==undefined?e.canvas:document.createElement("canvas"),E=n.width,d=n.height,h=Math.floor(E/2),m=Math.floor(d/2),u=0,v=0,x=E,y=d,r=1,C=n.getContext("2d",{alpha:e.alpha===true}),t=new THREE.Color(0),o=e.alpha===true?0:1,a=1,R=0,g=null,T=null,S=null,w=null,H=null,i=[],M,b,L,B,P,V=new THREE.RenderableVertex,W=new THREE.RenderableVertex,z,j,k,D,F,I,N,O,A,G,U,q,J=new THREE.Color,K=new THREE.Color,Q=new THREE.Color,X=new THREE.Color,Y=new THREE.Color,Z=new THREE.Color,$=new THREE.Color,_=new THREE.Color,ee={},ie,te,ne,re,oe,ae,se,le,ce=new THREE.Box2,fe=new THREE.Box2,pe=new THREE.Box2,Ee=new THREE.Color,de=new THREE.Color,ue=new THREE.Color,he=new THREE.Vector3,me=new THREE.Vector3,ve=new THREE.Vector3,xe=new THREE.Matrix3;if(C.setLineDash===undefined){C.setLineDash=function(){}}this.domElement=n;this.autoClear=true;this.sortObjects=true;this.sortElements=true;this.info={render:{vertices:0,faces:0}};this.supportsVertexTextures=function(){};this.setFaceCulling=function(){};this.getContext=function(){return C};this.getContextAttributes=function(){return C.getContextAttributes()};this.getPixelRatio=function(){return r};this.setPixelRatio=function(e){if(e!==undefined)r=e};this.setSize=function(e,i,t){E=e*r;d=i*r;n.width=E;n.height=d;h=Math.floor(E/2);m=Math.floor(d/2);if(t!==false){n.style.width=e+"px";n.style.height=i+"px"}ce.min.set(-h,-m);ce.max.set(h,m);fe.min.set(-h,-m);fe.max.set(h,m);a=1;R=0;g=null;T=null;S=null;w=null;H=null;this.setViewport(0,0,e,i)};this.setViewport=function(e,i,t,n){u=e*r;v=i*r;x=t*r;y=n*r};this.setScissor=function(){};this.setScissorTest=function(){};this.setClearColor=function(e,i){t.set(e);o=i!==undefined?i:1;fe.min.set(-h,-m);fe.max.set(h,m)};this.setClearColorHex=function(e,i){console.warn("THREE.CanvasRenderer: .setClearColorHex() is being removed. Use .setClearColor() instead.");this.setClearColor(e,i)};this.getClearColor=function(){return t};this.getClearAlpha=function(){return o};this.getMaxAnisotropy=function(){return 0};this.clear=function(){if(fe.isEmpty()===false){fe.intersect(ce);fe.expandByScalar(2);fe.min.x=fe.min.x+h;fe.min.y=-fe.min.y+m;fe.max.x=fe.max.x+h;fe.max.y=-fe.max.y+m;if(o<1){C.clearRect(fe.min.x|0,fe.max.y|0,fe.max.x-fe.min.x|0,fe.min.y-fe.max.y|0)}if(o>0){Ve(THREE.NormalBlending);Pe(1);De("rgba("+Math.floor(t.r*255)+","+Math.floor(t.g*255)+","+Math.floor(t.b*255)+","+o+")");C.fillRect(fe.min.x|0,fe.max.y|0,fe.max.x-fe.min.x|0,fe.min.y-fe.max.y|0)}fe.makeEmpty()}};this.clearColor=function(){};this.clearDepth=function(){};this.clearStencil=function(){};this.render=function(e,i){if(i instanceof THREE.Camera===false){console.error("THREE.CanvasRenderer.render: camera is not an instance of THREE.Camera.");return}var t=e.background;if(t&&t.isColor){De("rgb("+Math.floor(t.r*255)+","+Math.floor(t.g*255)+","+Math.floor(t.b*255)+")");C.fillRect(0,0,E,d)}else if(this.autoClear===true){this.clear()}c.info.render.vertices=0;c.info.render.faces=0;C.setTransform(x/E,0,0,-y/d,u,d-v);C.translate(h,m);s=p.projectScene(e,i,this.sortObjects,this.sortElements);l=s.elements;f=s.lights;M=i;xe.getNormalMatrix(i.matrixWorldInverse);ye();for(var n=0,r=l.length;n<r;n++){var o=l[n];var a=o.material;if(a===undefined||a.opacity===0)continue;pe.makeEmpty();if(o instanceof THREE.RenderableSprite){b=o;b.x*=h;b.y*=m;ge(b,o,a)}else if(o instanceof THREE.RenderableLine){b=o.v1;L=o.v2;b.positionScreen.x*=h;b.positionScreen.y*=m;L.positionScreen.x*=h;L.positionScreen.y*=m;pe.setFromPoints([b.positionScreen,L.positionScreen]);if(ce.intersectsBox(pe)===true){Te(b,L,o,a)}}else if(o instanceof THREE.RenderableFace){b=o.v1;L=o.v2;B=o.v3;if(b.positionScreen.z<-1||b.positionScreen.z>1)continue;if(L.positionScreen.z<-1||L.positionScreen.z>1)continue;if(B.positionScreen.z<-1||B.positionScreen.z>1)continue;b.positionScreen.x*=h;b.positionScreen.y*=m;L.positionScreen.x*=h;L.positionScreen.y*=m;B.positionScreen.x*=h;B.positionScreen.y*=m;if(a.overdraw>0){Be(b.positionScreen,L.positionScreen,a.overdraw);Be(L.positionScreen,B.positionScreen,a.overdraw);Be(B.positionScreen,b.positionScreen,a.overdraw)}pe.setFromPoints([b.positionScreen,L.positionScreen,B.positionScreen]);if(ce.intersectsBox(pe)===true){Se(b,L,B,0,1,2,o,a)}}fe.union(pe)}C.setTransform(1,0,0,1,0,0)};function ye(){Ee.setRGB(0,0,0);de.setRGB(0,0,0);ue.setRGB(0,0,0);for(var e=0,i=f.length;e<i;e++){var t=f[e];var n=t.color;if(t instanceof THREE.AmbientLight){Ee.add(n)}else if(t instanceof THREE.DirectionalLight){de.add(n)}else if(t instanceof THREE.PointLight){ue.add(n)}}}function Re(e,i,t){for(var n=0,r=f.length;n<r;n++){var o=f[n];_.copy(o.color);if(o instanceof THREE.DirectionalLight){var a=he.setFromMatrixPosition(o.matrixWorld).normalize();var s=i.dot(a);if(s<=0)continue;s*=o.intensity;t.add(_.multiplyScalar(s))}else if(o instanceof THREE.PointLight){var a=he.setFromMatrixPosition(o.matrixWorld);var s=i.dot(he.subVectors(a,e).normalize());if(s<=0)continue;s*=o.distance==0?1:1-Math.min(e.distanceTo(a)/o.distance,1);if(s==0)continue;s*=o.intensity;t.add(_.multiplyScalar(s))}}}function ge(e,i,t){Pe(t.opacity);Ve(t.blending);var n=i.scale.x*h;var r=i.scale.y*m;var o=.5*Math.sqrt(n*n+r*r);pe.min.set(e.x-o,e.y-o);pe.max.set(e.x+o,e.y+o);if(t instanceof THREE.SpriteMaterial){var a=t.map;if(a!==null){var s=ee[a.id];if(s===undefined||s.version!==a.version){s=Me(a);ee[a.id]=s}if(s.canvas!==undefined){De(s.canvas);var l=a.image;var c=l.width*a.offset.x;var f=l.height*a.offset.y;var p=l.width*a.repeat.x;var E=l.height*a.repeat.y;var d=n/p;var u=r/E;C.save();C.translate(e.x,e.y);if(t.rotation!==0)C.rotate(t.rotation);C.translate(-n/2,-r/2);C.scale(d,u);C.translate(-c,-f);C.fillRect(c,f,p,E);C.restore()}}else{De(t.color.getStyle());C.save();C.translate(e.x,e.y);if(t.rotation!==0)C.rotate(t.rotation);C.scale(n,-r);C.fillRect(-.5,-.5,1,1);C.restore()}}else if(t instanceof THREE.SpriteCanvasMaterial){ke(t.color.getStyle());De(t.color.getStyle());C.save();C.translate(e.x,e.y);if(t.rotation!==0)C.rotate(t.rotation);C.scale(n,r);t.program(C);C.restore()}}function Te(e,i,t,n){Pe(n.opacity);Ve(n.blending);C.beginPath();C.moveTo(e.positionScreen.x,e.positionScreen.y);C.lineTo(i.positionScreen.x,i.positionScreen.y);if(n instanceof THREE.LineBasicMaterial){We(n.linewidth);ze(n.linecap);je(n.linejoin);if(n.vertexColors!==THREE.VertexColors){ke(n.color.getStyle())}else{var r=t.vertexColors[0].getStyle();var o=t.vertexColors[1].getStyle();if(r===o){ke(r)}else{try{var a=C.createLinearGradient(e.positionScreen.x,e.positionScreen.y,i.positionScreen.x,i.positionScreen.y);a.addColorStop(0,r);a.addColorStop(1,o)}catch(e){a=r}ke(a)}}C.stroke();pe.expandByScalar(n.linewidth*2)}else if(n instanceof THREE.LineDashedMaterial){We(n.linewidth);ze(n.linecap);je(n.linejoin);ke(n.color.getStyle());Fe([n.dashSize,n.gapSize]);C.stroke();pe.expandByScalar(n.linewidth*2);Fe([])}}function Se(e,i,t,n,r,o,a,s){c.info.render.vertices+=3;c.info.render.faces++;Pe(s.opacity);Ve(s.blending);z=e.positionScreen.x;j=e.positionScreen.y;k=i.positionScreen.x;D=i.positionScreen.y;F=t.positionScreen.x;I=t.positionScreen.y;we(z,j,k,D,F,I);if((s instanceof THREE.MeshLambertMaterial||s instanceof THREE.MeshPhongMaterial)&&s.map===null){Z.copy(s.color);$.copy(s.emissive);if(s.vertexColors===THREE.FaceColors){Z.multiply(a.color)}J.copy(Ee);me.copy(e.positionWorld).add(i.positionWorld).add(t.positionWorld).divideScalar(3);Re(me,a.normalModel,J);J.multiply(Z).add($);s.wireframe===true?He(J,s.wireframeLinewidth,s.wireframeLinecap,s.wireframeLinejoin):Ce(J)}else if(s instanceof THREE.MeshBasicMaterial||s instanceof THREE.MeshLambertMaterial||s instanceof THREE.MeshPhongMaterial){if(s.map!==null){var l=s.map.mapping;if(l===THREE.UVMapping){te=a.uvs;be(z,j,k,D,F,I,te[n].x,te[n].y,te[r].x,te[r].y,te[o].x,te[o].y,s.map)}}else if(s.envMap!==null){if(s.envMap.mapping===THREE.SphericalReflectionMapping){ve.copy(a.vertexNormalsModel[n]).applyMatrix3(xe);ne=.5*ve.x+.5;re=.5*ve.y+.5;ve.copy(a.vertexNormalsModel[r]).applyMatrix3(xe);oe=.5*ve.x+.5;ae=.5*ve.y+.5;ve.copy(a.vertexNormalsModel[o]).applyMatrix3(xe);se=.5*ve.x+.5;le=.5*ve.y+.5;be(z,j,k,D,F,I,ne,re,oe,ae,se,le,s.envMap)}}else{J.copy(s.color);if(s.vertexColors===THREE.FaceColors){J.multiply(a.color)}s.wireframe===true?He(J,s.wireframeLinewidth,s.wireframeLinecap,s.wireframeLinejoin):Ce(J)}}else if(s instanceof THREE.MeshNormalMaterial){ve.copy(a.normalModel).applyMatrix3(xe);J.setRGB(ve.x,ve.y,ve.z).multiplyScalar(.5).addScalar(.5);s.wireframe===true?He(J,s.wireframeLinewidth,s.wireframeLinecap,s.wireframeLinejoin):Ce(J)}else{J.setRGB(1,1,1);s.wireframe===true?He(J,s.wireframeLinewidth,s.wireframeLinecap,s.wireframeLinejoin):Ce(J)}}function we(e,i,t,n,r,o){C.beginPath();C.moveTo(e,i);C.lineTo(t,n);C.lineTo(r,o);C.closePath()}function He(e,i,t,n){We(i);ze(t);je(n);ke(e.getStyle());C.stroke();pe.expandByScalar(i*2)}function Ce(e){De(e.getStyle());C.fill()}function Me(e){if(e.version===0||e instanceof THREE.CompressedTexture||e instanceof THREE.DataTexture){return{canvas:undefined,version:e.version}}var i=e.image;if(i.complete===false){return{canvas:undefined,version:0}}var t=e.wrapS===THREE.RepeatWrapping||e.wrapS===THREE.MirroredRepeatWrapping;var n=e.wrapT===THREE.RepeatWrapping||e.wrapT===THREE.MirroredRepeatWrapping;var r=e.wrapS===THREE.MirroredRepeatWrapping;var o=e.wrapT===THREE.MirroredRepeatWrapping;var a=document.createElement("canvas");a.width=i.width*(r?2:1);a.height=i.height*(o?2:1);var s=a.getContext("2d");s.setTransform(1,0,0,-1,0,i.height);s.drawImage(i,0,0);if(r===true){s.setTransform(-1,0,0,-1,i.width,i.height);s.drawImage(i,-i.width,0)}if(o===true){s.setTransform(1,0,0,1,0,0);s.drawImage(i,0,i.height)}if(r===true&&o===true){s.setTransform(-1,0,0,1,i.width,0);s.drawImage(i,-i.width,i.height)}var l="no-repeat";if(t===true&&n===true){l="repeat"}else if(t===true){l="repeat-x"}else if(n===true){l="repeat-y"}var c=C.createPattern(a,l);if(e.onUpdate)e.onUpdate(e);return{canvas:c,version:e.version}}function be(e,i,t,n,r,o,a,s,l,c,f,p,E){var d=ee[E.id];if(d===undefined||d.version!==E.version){d=Me(E);ee[E.id]=d}if(d.canvas!==undefined){De(d.canvas)}else{De("rgba( 0, 0, 0, 1)");C.fill();return}var u,h,m,v,x,y,R,g,T=E.offset.x/E.repeat.x,S=E.offset.y/E.repeat.y,w=E.image.width*E.repeat.x,H=E.image.height*E.repeat.y;a=(a+T)*w;s=(s+S)*H;l=(l+T)*w;c=(c+S)*H;f=(f+T)*w;p=(p+S)*H;t-=e;n-=i;r-=e;o-=i;l-=a;c-=s;f-=a;p-=s;R=l*p-f*c;if(R===0)return;g=1/R;u=(p*t-c*r)*g;h=(p*n-c*o)*g;m=(l*r-f*t)*g;v=(l*o-f*n)*g;x=e-u*a-m*s;y=i-h*a-v*s;C.save();C.transform(u,h,m,v,x,y);C.fill();C.restore()}function Le(e,i,t,n,r,o,a,s,l,c,f,p,E){var d,u,h,m,v,x,y,R,g=E.width-1,T=E.height-1;a*=g;s*=T;l*=g;c*=T;f*=g;p*=T;t-=e;n-=i;r-=e;o-=i;l-=a;c-=s;f-=a;p-=s;y=l*p-f*c;R=1/y;d=(p*t-c*r)*R;u=(p*n-c*o)*R;h=(l*r-f*t)*R;m=(l*o-f*n)*R;v=e-d*a-h*s;x=i-u*a-m*s;C.save();C.transform(d,u,h,m,v,x);C.clip();C.drawImage(E,0,0);C.restore()}function Be(e,i,t){var n=i.x-e.x,r=i.y-e.y,o=n*n+r*r,a;if(o===0)return;a=t/Math.sqrt(o);n*=a;r*=a;i.x+=n;i.y+=r;e.x-=n;e.y-=r}function Pe(e){if(a!==e){C.globalAlpha=e;a=e}}function Ve(e){if(R!==e){if(e===THREE.NormalBlending){C.globalCompositeOperation="source-over"}else if(e===THREE.AdditiveBlending){C.globalCompositeOperation="lighter"}else if(e===THREE.SubtractiveBlending){C.globalCompositeOperation="darker"}else if(e===THREE.MultiplyBlending){C.globalCompositeOperation="multiply"}R=e}}function We(e){if(S!==e){C.lineWidth=e;S=e}}function ze(e){if(w!==e){C.lineCap=e;w=e}}function je(e){if(H!==e){C.lineJoin=e;H=e}}function ke(e){if(g!==e){C.strokeStyle=e;g=e}}function De(e){if(T!==e){C.fillStyle=e;T=e}}function Fe(e){if(i.length!==e.length){C.setLineDash(e);i=e}}};